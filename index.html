<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë§ˆìŠ¤í„°ì˜ ë‹¬ë ¥í˜• ê°€ê³„ë¶€</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin:40px; }
    h1 { margin-bottom: 10px;}
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #eee; border:1px solid #ddd;}
    .calendar-header, .calendar-day {
      padding: 12px 0; text-align: center; background: #fff;
    }
    .calendar-header { font-weight:bold; background: #f6f6f6;}
    .calendar-day.today { background: #ffe08c; }
    .calendar-day.has-data { background: #fffae3; border: 1.5px solid #ffb300;}
    .calendar-day:hover { background:#e0eaff; cursor:pointer; }
    .calendar-day.empty { background: #f9f9f9; }
    .summary-table { margin:30px 0; width:auto;}
    #charts { display:flex; flex-wrap:wrap; gap:30px; margin-top:30px;}
    .chart-area { width:340px; }
    .entry-list table {width:100%; border-collapse:collapse;}
    .entry-list th, .entry-list td { border:1px solid #ccc; padding:6px;}
    .entry-list th {background:#fafafa;}
    .input-area {margin:12px 0; display:flex; gap:8px;}
    .input-area select, .input-area input {padding:5px;}
    @media (max-width:600px) {
      body { margin:6px; }
      .calendar-header, .calendar-day { padding: 8px 0;}
      #charts {flex-direction:column;}
      .chart-area {width:100%;}
    }
  </style>
</head>
<body>
  <h1>ğŸ“… ë§ˆìŠ¤í„°ì˜ ë‹¬ë ¥í˜• ê°€ê³„ë¶€</h1>
  <div>
    <button id="prevMonth">â—€ ì´ì „ë‹¬</button>
    <span id="monthTitle" style="font-size:1.2em;font-weight:bold;"></span>
    <button id="nextMonth">ë‹¤ìŒë‹¬ â–¶</button>
  </div>
  <div class="calendar" id="calendar"></div>

  <div id="entryBox" style="display:none;">
    <h3 id="selectedDate"></h3>
    <form id="entryForm" class="input-area">
      <select id="mainCategory" required>
        <option value="ì†Œë¹„">ì†Œë¹„</option>
        <option value="íˆ¬ì">íˆ¬ì</option>
        <option value="ìˆ˜ì…">ìˆ˜ì…</option>
      </select>
      <select id="subCategory"></select>
      <input type="number" id="amount" placeholder="ê¸ˆì•¡" required/>
      <input type="text" id="note" placeholder="ë©”ëª¨"/>
      <button type="submit">ì¶”ê°€</button>
      <button type="button" id="closeEntry">ë‹«ê¸°</button>
    </form>
    <div class="entry-list">
      <table>
        <thead>
          <tr><th>í•­ëª©</th><th>í•˜ìœ„í•­ëª©</th><th>ê¸ˆì•¡</th><th>ë©”ëª¨</th><th></th></tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>
  </div>

  <div id="monthlySummary"></div>
  <div id="charts"></div>
  <div id="annualSummary"></div>

<script>
  // í•˜ìœ„ ì¹´í…Œê³ ë¦¬
  const subCategories = {
    'ì†Œë¹„': ['ì‹ë¹„', 'êµí†µë¹„', 'ê³ ì •ì§€ì¶œ', 'ê³µê³¼ê¸ˆ', 'ê±°ì£¼ë¹„ìš©', 'ë¬¸í™”ë¹„', 'ìê¸°ê°œë°œë¹„', 'ê¸°íƒ€(ì†Œë¹„)'],
    'íˆ¬ì': ['ì ê¸ˆ', 'ë³´í—˜', 'ì£¼ì‹', 'ê°€ìƒí™”í', 'ìˆ˜ì§‘í’ˆ', 'ê¸°íƒ€(íˆ¬ì)'],
    'ìˆ˜ì…': ['ì›”ê¸‰', 'ì´ììˆ˜ì…', 'ë°°ë‹¹ìˆ˜ì…', 'ê¸°íƒ€ìˆ˜ì…']
  };
  const today = new Date();
  let currentYear = today.getFullYear();
  let currentMonth = today.getMonth(); // 0-indexed
  let allData = {}; // {'YYYY-MM-DD': [{main,sub,amount,note}]}
  let initialAsset = 0;

  // ë‹¬ë ¥ ê·¸ë¦¬ê¸°
  function renderCalendar(year, month) {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';
    document.getElementById('monthTitle').textContent = `${year}ë…„ ${month+1}ì›”`;

    const weekDays = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    for(let d of weekDays) {
      let hd = document.createElement('div');
      hd.className = 'calendar-header';
      hd.textContent = d;
      calendar.appendChild(hd);
    }
    let firstDay = new Date(year, month, 1).getDay();
    let lastDate = new Date(year, month+1, 0).getDate();
    // ì• ë¹ˆì¹¸
    for(let i=0; i<firstDay; i++) {
      let emp = document.createElement('div');
      emp.className = 'calendar-day empty';
      calendar.appendChild(emp);
    }
    for(let date=1; date<=lastDate; date++) {
      let day = new Date(year, month, date);
      let key = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
      let hasData = allData[key] && allData[key].length>0;
      let cell = document.createElement('div');
      cell.className = 'calendar-day' + 
        (today.getFullYear()===year&&today.getMonth()===month&&today.getDate()===date?' today':'') +
        (hasData?' has-data':'');
      cell.textContent = date + (hasData?' â—':'');
      cell.onclick = () => showEntryBox(key, year, month, date);
      calendar.appendChild(cell);
    }
    updateMonthlySummary();
    updateCharts();
    updateAnnualSummary();
  }

  // ì…ë ¥ë°•ìŠ¤ show/hide ë° ë°ì´í„° ì±„ìš°ê¸°
  function showEntryBox(key, year, month, date) {
    document.getElementById('entryBox').style.display = 'block';
    document.getElementById('selectedDate').textContent = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')} ë‚´ì—­`;
    renderEntryTable(key);

    // ì…ë ¥ í¼ ì´ˆê¸°í™”
    document.getElementById('entryForm').onsubmit = function(e){
      e.preventDefault();
      const main = document.getElementById('mainCategory').value;
      const sub = document.getElementById('subCategory').value;
      const amount = Number(document.getElementById('amount').value);
      const note = document.getElementById('note').value;
      if(!allData[key]) allData[key] = [];
      allData[key].push({main,sub,amount,note});
      renderEntryTable(key);
      renderCalendar(currentYear, currentMonth);
      this.reset();
      updateSubCategories();
    };
    document.getElementById('closeEntry').onclick = () => {
      document.getElementById('entryBox').style.display = 'none';
    };
    document.getElementById('mainCategory').onchange = updateSubCategories;
    updateSubCategories();
  }
  // í•˜ìœ„í•­ëª© ë“œë¡­ë‹¤ìš´ ë™ì  ìƒì„±
  function updateSubCategories() {
    const main = document.getElementById('mainCategory').value;
    const subSel = document.getElementById('subCategory');
    subSel.innerHTML = '';
    for(let sub of subCategories[main]) {
      let opt = document.createElement('option');
      opt.value = sub; opt.textContent = sub;
      subSel.appendChild(opt);
    }
  }
  // ë‚´ì—­ í…Œì´ë¸” ê·¸ë¦¬ê¸°
  function renderEntryTable(key) {
    const table = document.getElementById('dataTable');
    table.innerHTML = '';
    (allData[key]||[]).forEach((item, idx)=>{
      let tr = document.createElement('tr');
      tr.innerHTML = `<td>${item.main}</td><td>${item.sub}</td><td>${item.amount}</td><td>${item.note}</td>
      <td><button onclick="deleteEntry('${key}',${idx})">ì‚­ì œ</button></td>`;
      table.appendChild(tr);
    });
  }
  // ë‚´ì—­ ì‚­ì œ
  window.deleteEntry = function(key, idx){
    if(allData[key]) {
      allData[key].splice(idx,1);
      renderEntryTable(key);
      renderCalendar(currentYear, currentMonth);
    }
  }
  // ì´ì „/ë‹¤ìŒë‹¬
  document.getElementById('prevMonth').onclick = () => {
    currentMonth--;
    if(currentMonth<0) { currentMonth=11; currentYear--; }
    renderCalendar(currentYear, currentMonth);
    document.getElementById('entryBox').style.display = 'none';
  };
  document.getElementById('nextMonth').onclick = () => {
    currentMonth++;
    if(currentMonth>11) { currentMonth=0; currentYear++; }
    renderCalendar(currentYear, currentMonth);
    document.getElementById('entryBox').style.display = 'none';
  };

  // ì›”ë³„ ì§‘ê³„ (ì†Œë¹„/íˆ¬ì/ìˆ˜ì…/ì‰ì—¬ê¸ˆ)
  function updateMonthlySummary() {
    let summary = {};
    Object.entries(allData).forEach(([date, arr])=>{
      const month = date.slice(0,7);
      if (!summary[month]) summary[month] = { ì†Œë¹„:0, íˆ¬ì:0, ìˆ˜ì…:0 };
      arr.forEach(item=>{
        summary[month][item.main] += Number(item.amount);
      });
    });
    let html = `<table class="summary-table"><tr>
      <th>ì›”</th>
      <th>ì†Œë¹„</th>
      <th>íˆ¬ì</th>
      <th>ìˆ˜ì…</th>
      <th>ì‰ì—¬ê¸ˆ</th>
    </tr>`;
    Object.keys(summary).sort().forEach(month=>{
      let ì†Œë¹„ = summary[month]['ì†Œë¹„']||0;
      let íˆ¬ì = summary[month]['íˆ¬ì']||0;
      let ìˆ˜ì… = summary[month]['ìˆ˜ì…']||0;
      let ì‰ì—¬ê¸ˆ = ìˆ˜ì… - (ì†Œë¹„ + íˆ¬ì);
      html += `<tr>
        <td>${month}</td>
        <td>${ì†Œë¹„}</td>
        <td>${íˆ¬ì}</td>
        <td>${ìˆ˜ì…}</td>
        <td>${ì‰ì—¬ê¸ˆ}</td>
      </tr>`;
    });
    html += `</table>`;
    document.getElementById('monthlySummary').innerHTML = html;
  }
  // ì›”ë³„ ê·¸ë˜í”„
  function updateCharts() {
    const chartDiv = document.getElementById('charts');
    chartDiv.innerHTML = '';
    const summary = {};
    Object.entries(allData).forEach(([date, arr])=>{
      const month = date.slice(0,7);
      if (!summary[month]) summary[month] = { ì†Œë¹„:0, íˆ¬ì:0, ìˆ˜ì…:0 };
      arr.forEach(item=>{
        summary[month][item.main] += Number(item.amount);
      });
    });
    Object.keys(summary).sort().forEach(month=>{
      const data = [
        summary[month]['ì†Œë¹„'],
        summary[month]['íˆ¬ì'],
        summary[month]['ìˆ˜ì…'],
      ];
      const colors = ['#ffb300','#82b1ff','#43a047'];
      const canvas = document.createElement('canvas');
      canvas.id = 'chart-'+month;
      canvas.width = 300; canvas.height = 300;
      chartDiv.appendChild(Object.assign(document.createElement('div'),{className:'chart-area',innerHTML:`<h4>${month} ì†Œë¹„/íˆ¬ì/ìˆ˜ì… ë¹„ìœ¨</h4>`}));
      chartDiv.lastChild.appendChild(canvas);
      new Chart(canvas.getContext('2d'),{
        type:'pie',
        data:{
          labels:['ì†Œë¹„','íˆ¬ì','ìˆ˜ì…'],
          datasets:[{
            data:data,
            backgroundColor: colors
          }]
        },
        options:{
          plugins:{ legend:{position:'bottom'} }
        }
      });
    });
  }
  // ì—°ë§ ìì‚°ì¦ê°/ê·¸ë˜í”„
  function updateAnnualSummary() {
    // ì—°ë„ë³„ ëˆ„ì ìì‚° = ì „ë…„+ìˆ˜ì…-ì†Œë¹„-íˆ¬ì
    let yearly = {};
    Object.entries(allData).forEach(([date, arr])=>{
      const [y] = date.split('-');
      if (!yearly[y]) yearly[y]={ì†Œë¹„:0,íˆ¬ì:0,ìˆ˜ì…:0};
      arr.forEach(item=>{
        yearly[y][item.main] += Number(item.amount);
      });
    });
    let years = Object.keys(yearly).sort();
    let assetArr = [];
    let yearSum = {};
    let prev = initialAsset;
    let html = "";
    years.forEach(y=>{
      let ì†Œë¹„ = yearly[y].ì†Œë¹„||0, íˆ¬ì=yearly[y].íˆ¬ì||0, ìˆ˜ì…=yearly[y].ìˆ˜ì…||0;
      let sum = ìˆ˜ì… - (ì†Œë¹„ + íˆ¬ì);
      yearSum[y] = sum;
      prev += sum;
      assetArr.push(prev);
    });
    if (years.length === 0) {
      document.getElementById('annualSummary').innerHTML = "";
      return;
    }
    html += `<h3>ğŸ“ˆ ì—°ë§ ìì‚°ë³€ë™</h3>`;
    html += `<table class="summary-table"><tr>
      <th>ì—°ë„</th><th>ìì‚°ì¦ê°(â‚©)</th><th>ëˆ„ì ìì‚°(â‚©)</th></tr>`;
    prev = initialAsset;
    years.forEach((y,i)=>{
      let sum = yearSum[y];
      prev += sum;
      html += `<tr>
        <td>${y}</td>
        <td>${sum>=0?"+":""}${sum}</td>
        <td>${prev}</td>
      </tr>`;
    });
    html += `</table>`;
    // ê·¸ë˜í”„
    html += `<canvas id="assetChart" width="400" height="260"></canvas>`;
    document.getElementById('annualSummary').innerHTML = html;
    // ì°¨íŠ¸
    const ctx = document.getElementById('assetChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: years,
        datasets: [{
          label: 'ëˆ„ì ìì‚°(â‚©)',
          data: assetArr,
          fill: false,
          borderColor: '#42a5f5',
          tension: 0.1
        }]
      },
      options: {
        plugins: {
          legend: { display: false }
        }
      }
    });
    // ë©”ì‹œì§€
    if (years.length > 1) {
      let last = assetArr[assetArr.length-1], prevY = assetArr[assetArr.length-2];
      let pct = prevY===0 ? 0 : ((last-prevY)/Math.abs(prevY)*100).toFixed(1);
      html += `<p><b>ì—°ë§ ë©”ì‹œì§€:</b> ì˜¬í•´ ìì‚°ì€ ì‘ë…„ ëŒ€ë¹„ <b>${pct}% ${last-prevY>=0?'ì¦ê°€':'ê°ì†Œ'}</b>í–ˆìŠµë‹ˆë‹¤.</p>`;
      document.getElementById('annualSummary').innerHTML = html;
    }
  }
  // ì´ˆê¸°í™”
  renderCalendar(currentYear, currentMonth);
</script>
</body>
</html>
