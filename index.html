<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚˜ì˜ ê°€ê³„ë¶€</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      transition: background 0.5s; 
      margin: 0;
      padding: 0;
      background-color: #f4f7f6;
    }
    .container { 
      max-width: 1200px; 
      margin: auto; 
      padding: 20px; 
    }
    .header { 
      text-align: center; 
      margin-bottom: 20px; 
      background: rgba(255, 255, 255, 0.7);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .season-info { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 15px; 
      margin-bottom: 20px; 
    }
    .season-info img { 
      width: 50px; 
      height: 50px; 
    }
    #seasonFoods span { 
      background-color: rgba(0,0,0,0.05); 
      padding: 5px 10px; 
      border-radius: 15px; 
      margin: 0 4px; 
      font-size: 0.9em; 
      display: inline-block;
      margin-top: 5px;
    }
    .calendar-controls { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 10px; 
    }
    .calendar-controls button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .calendar-controls button:hover {
      background-color: #0056b3;
    }
    #calendar { 
      display: grid; 
      grid-template-columns: repeat(7, 1fr); 
      gap: 5px; 
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .calendar-header, .calendar-day { 
      padding: 10px; 
      text-align: center; 
      border-radius: 5px; 
    }
    .calendar-header { 
      background-color: #f0f0f0; 
      font-weight: bold; 
    }
    .calendar-day { 
      background-color: #fff; 
      cursor: pointer; 
      border: 1px solid #eee;
      min-height: 60px;
    }
    .calendar-day:hover { 
      background-color: #e9ecef; 
    }
    .calendar-day.empty { 
      background-color: transparent; 
      cursor: default; 
      border: none;
    }
    .calendar-day.today { 
      border: 2px solid #42a5f5; 
      font-weight: bold; 
    }
    .calendar-day.has-data { 
      font-weight: bold;
      color: #d32f2f; 
    }
    #entryBox { 
      display: none; 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: white; 
      padding: 25px; 
      border-radius: 10px; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
      z-index: 100; 
      width: 90%; 
      max-width: 500px; 
    }
    #entryForm { 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
    }
    #entryForm input, #entryForm select, #entryForm button {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #entryForm button {
      background-color: #28a745;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .summary-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .summary-table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 10px; 
    }
    .summary-table th, .summary-table td { 
      border: 1px solid #ddd; 
      padding: 8px; 
      text-align: right; 
    }
    .summary-table th { 
      background-color: #f2f2f2; 
      text-align: center; 
    }
    .charts-container { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 20px; 
      justify-content: center; 
      margin-top: 20px; 
    }
    .chart-area { 
      text-align: center; 
    }
    hr {
      border: none;
      border-top: 1px solid #eee;
      margin: 30px 0;
    }
  </style>
</head>
<body>

  <div class="container">
    <header class="header">
      <div class="season-info">
        <img id="seasonImg" src="" alt="season-icon">
        <div>
          <h2 id="seasonText"></h2>
          <div id="seasonFoods"></div>
        </div>
      </div>
      <div class="calendar-controls">
        <button id="prevMonth">â—€ ì´ì „ ë‹¬</button>
        <h1 id="monthTitle"></h1>
        <button id="nextMonth">ë‹¤ìŒ ë‹¬ â–¶</button>
      </div>
    </header>
    
    <main>
      <div id="calendar"></div>
      
      <div class="summary-section" id="monthlySummary"></div>

      <div class="summary-section" id="annualSummary"></div>
      
      <div class="summary-section">
        <h3>ì›”ë³„ ìƒì„¸ ì°¨íŠ¸</h3>
        <div class="charts-container" id="charts"></div>
      </div>

    </main>
  </div>

  <div id="entryBox">
    <h3 id="selectedDate"></h3>
    <form id="entryForm">
      <select id="mainCategory">
        <option value="ì†Œë¹„">ì†Œë¹„</option>
        <option value="íˆ¬ì">íˆ¬ì</option>
        <option value="ìˆ˜ì…">ìˆ˜ì…</option>
      </select>
      <select id="subCategory"></select>
      <input type="number" id="amount" placeholder="ê¸ˆì•¡" required>
      <input type="text" id="note" placeholder="ë©”ëª¨">
      <button type="submit">ì €ì¥</button>
    </form>
    <table class="summary-table" style="margin-top: 20px;">
      <thead>
        <tr><th>ëŒ€ë¶„ë¥˜</th><th>ì†Œë¶„ë¥˜</th><th>ê¸ˆì•¡</th><th>ë©”ëª¨</th><th>ì‚­ì œ</th></tr>
      </thead>
      <tbody id="dataTable"></tbody>
    </table>
    <button id="closeEntry" style="margin-top: 15px;">ë‹«ê¸°</button>
  </div>

  <script>
    // 1. ê³„ì ˆ/ì œì²  ì‹í’ˆ/ì´ë¯¸ì§€/íŒŒìŠ¤í…”í†¤
    const SEASON_MAP = [
      { name: "ë´„", months: [3,4,5], bg: "#ffeef7", img: "https://openmoji.org/data/color/svg/1F353.svg", foods: ["ë”¸ê¸°ğŸ“", "ë‘ë¦…", "ì‘¥", "ë‹¬ë˜", "ë¯¸ë‚˜ë¦¬"] },
      { name: "ì—¬ë¦„", months: [6,7,8], bg: "#e3faff", img: "https://openmoji.org/data/color/svg/1F349.svg", foods: ["ìˆ˜ë°•ğŸ‰", "ì°¸ì™¸", "ì˜¥ìˆ˜ìˆ˜ğŸŒ½", "ì˜¤ì´ğŸ¥’"] },
      { name: "ê°€ì„", months: [9,10,11], bg: "#fff7e3", img: "https://openmoji.org/data/color/svg/1F34E.svg", foods: ["ë°¤ğŸŒ°", "ê°", "ì‚¬ê³¼ğŸ", "ê³ êµ¬ë§ˆ", "ë²„ì„¯"] },
      { name: "ê²¨ìš¸", months: [12,1,2], bg: "#eaf3ff", img: "https://openmoji.org/data/color/svg/1F34A.svg", foods: ["ê·¤ğŸŠ", "ë°°ì¶”", "ë¬´", "ëŒ€íŒŒ", "ë°©ì–´ğŸŸ"] }
    ];
    function getSeason(month) { return SEASON_MAP.find(season => season.months.includes(month)); }
    function updateSeasonUI(month) {
      const season = getSeason(month);
      document.body.style.background = season.bg;
      document.getElementById('seasonImg').src = season.img;
      document.getElementById('seasonText').textContent = `${season.name}ì˜ ì œì² `;
      document.getElementById('seasonFoods').innerHTML = season.foods.map(f => `<span>${f}</span>`).join('');
    }

    // 2. ê°€ê³„ë¶€/ë‹¬ë ¥ ê¸°ë³¸
    const subCategories = {
      'ì†Œë¹„': ['ì‹ë¹„', 'êµí†µë¹„', 'ê³ ì •ì§€ì¶œ', 'ê³µê³¼ê¸ˆ', 'ê±°ì£¼ë¹„ìš©', 'ë¬¸í™”ë¹„', 'ìê¸°ê°œë°œë¹„', 'ê¸°íƒ€(ì†Œë¹„)'],
      'íˆ¬ì': ['ì ê¸ˆ', 'ë³´í—˜', 'ì£¼ì‹', 'ê°€ìƒí™”í', 'ìˆ˜ì§‘í’ˆ', 'ê¸°íƒ€(íˆ¬ì)'],
      'ìˆ˜ì…': ['ì›”ê¸‰', 'ì´ììˆ˜ì…', 'ë°°ë‹¹ìˆ˜ì…', 'ê¸°íƒ€ìˆ˜ì…']
    };
    const today = new Date();
    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth();
    let allData = {};
    let initialAsset = 0;

    function renderCalendar(year, month) {
      updateSeasonUI(month+1);
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';
      document.getElementById('monthTitle').textContent = `${year}ë…„ ${month+1}ì›”`;
      const weekDays = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      weekDays.forEach(d => {
        let hd = document.createElement('div');
        hd.className = 'calendar-header'; hd.textContent = d; calendar.appendChild(hd);
      });
      let firstDay = new Date(year, month, 1).getDay();
      let lastDate = new Date(year, month+1, 0).getDate();
      for(let i=0; i<firstDay; i++) {
        let emp = document.createElement('div'); emp.className = 'calendar-day empty'; calendar.appendChild(emp);
      }
      for(let date=1; date<=lastDate; date++) {
        let key = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
        let hasData = allData[key] && allData[key].length>0;
        let cell = document.createElement('div');
        cell.className = 'calendar-day' + (today.getFullYear()===year&&today.getMonth()===month&&today.getDate()===date?' today':'') + (hasData?' has-data':'');
        let dateSpan = document.createElement('span'); dateSpan.textContent = date; cell.appendChild(dateSpan);
        if(hasData) { let dot = document.createElement('div'); dot.textContent = 'â—'; dot.style.fontSize = '0.7em'; cell.appendChild(dot); }
        cell.onclick = () => showEntryBox(key, year, month, date);
        calendar.appendChild(cell);
      }
      updateMonthlySummary();
      updateCharts();
      updateAnnualSummary();
    }

    function showEntryBox(key, year, month, date) {
      document.getElementById('entryBox').style.display = 'block';
      document.getElementById('selectedDate').textContent = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')} ë‚´ì—­`;
      renderEntryTable(key);
      const form = document.getElementById('entryForm');
      form.onsubmit = null; 
      form.onsubmit = function(e){
        e.preventDefault();
        const main = document.getElementById('mainCategory').value;
        const sub = document.getElementById('subCategory').value;
        const amount = Number(document.getElementById('amount').value);
        const note = document.getElementById('note').value;
        if(!allData[key]) allData[key] = [];
        allData[key].push({main,sub,amount,note});
        renderEntryTable(key);
        renderCalendar(currentYear, currentMonth);
        this.reset();
        updateSubCategories();
      };
      document.getElementById('closeEntry').onclick = () => { document.getElementById('entryBox').style.display = 'none'; };
      document.getElementById('mainCategory').onchange = updateSubCategories;
      updateSubCategories();
    }
    function updateSubCategories() {
      const main = document.getElementById('mainCategory').value;
      const subSel = document.getElementById('subCategory');
      subSel.innerHTML = '';
      subCategories[main].forEach(sub => {
        let opt = document.createElement('option'); opt.value = sub; opt.textContent = sub; subSel.appendChild(opt);
      });
    }
    function renderEntryTable(key) {
      const table = document.getElementById('dataTable');
      table.innerHTML = '';
      (allData[key]||[]).forEach((item, idx)=>{
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.main}</td><td>${item.sub}</td><td>${item.amount.toLocaleString()}</td><td>${item.note}</td>
        <td><button onclick="deleteEntry('${key}',${idx})">ì‚­ì œ</button></td>`;
        table.appendChild(tr);
      });
    }
    window.deleteEntry = function(key, idx){
      if(confirm('ì •ë§ë¡œ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        if(allData[key]) {
          allData[key].splice(idx,1);
          renderEntryTable(key);
          renderCalendar(currentYear, currentMonth);
        }
      }
    }
    document.getElementById('prevMonth').onclick = () => {
      currentMonth--; if(currentMonth<0) { currentMonth=11; currentYear--; }
      renderCalendar(currentYear, currentMonth); document.getElementById('entryBox').style.display = 'none';
    };
    document.getElementById('nextMonth').onclick = () => {
      currentMonth++; if(currentMonth>11) { currentMonth=0; currentYear++; }
      renderCalendar(currentYear, currentMonth); document.getElementById('entryBox').style.display = 'none';
    };

    function updateMonthlySummary() {
      const monthlySummaryDiv = document.getElementById('monthlySummary');
      let summary = {};
      Object.entries(allData).forEach(([date, arr])=>{
        const month = date.slice(0,7);
        if (!summary[month]) summary[month] = { ì†Œë¹„:0, íˆ¬ì:0, ìˆ˜ì…:0 };
        arr.forEach(item=>{ summary[month][item.main] += Number(item.amount); });
      });
      let html = `<h3>ì›”ë³„ ìš”ì•½</h3>`;
      if (Object.keys(summary).length === 0) {
        monthlySummaryDiv.innerHTML = html + "<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"; return;
      }
      html += `<table class="summary-table"><tr><th>ì›”</th><th>ì†Œë¹„</th><th>íˆ¬ì</th><th>ìˆ˜ì…</th><th>ì‰ì—¬ê¸ˆ</th></tr>`;
      Object.keys(summary).sort().forEach(month=>{
        let ì†Œë¹„ = summary[month]['ì†Œë¹„']||0, íˆ¬ì = summary[month]['íˆ¬ì']||0, ìˆ˜ì… = summary[month]['ìˆ˜ì…']||0;
        let ì‰ì—¬ê¸ˆ = ìˆ˜ì… - (ì†Œë¹„ + íˆ¬ì);
        html += `<tr><td>${month}</td><td>${ì†Œë¹„.toLocaleString()}</td><td>${íˆ¬ì.toLocaleString()}</td><td>${ìˆ˜ì….toLocaleString()}</td><td>${ì‰ì—¬ê¸ˆ.toLocaleString()}</td></tr>`;
      });
      html += `</table>`;
      monthlySummaryDiv.innerHTML = html;
    }
    function updateCharts() {
      const chartDiv = document.getElementById('charts');
      chartDiv.innerHTML = '';
      const summary = {};
      Object.entries(allData).forEach(([date, arr])=>{
        const month = date.slice(0,7);
        if (!summary[month]) summary[month] = { ì†Œë¹„:0, íˆ¬ì:0, ìˆ˜ì…:0 };
        arr.forEach(item=>{ summary[month][item.main] += Number(item.amount); });
      });
      Object.keys(summary).sort().forEach(month=>{
        const data = [ summary[month]['ì†Œë¹„'], summary[month]['íˆ¬ì'], summary[month]['ìˆ˜ì…'] ];
        if (data.every(item => item === 0)) return;
        const colors = ['#ffb300','#82b1ff','#43a047'];
        const canvas = document.createElement('canvas'); canvas.id = 'chart-'+month;
        const chartArea = document.createElement('div'); chartArea.className = 'chart-area';
        chartArea.innerHTML = `<h4>${month} ì†Œë¹„/íˆ¬ì/ìˆ˜ì… ë¹„ìœ¨</h4>`; chartArea.appendChild(canvas);
        chartDiv.appendChild(chartArea);
        new Chart(canvas.getContext('2d'),{ type:'pie', data:{ labels:['ì†Œë¹„','íˆ¬ì','ìˆ˜ì…'], datasets:[{ data:data, backgroundColor: colors }] }, options:{ responsive: true, maintainAspectRatio: false, plugins:{ legend:{position:'bottom'} } } });
      });
    }

    // ==========================================================
    // âœ¨âœ¨âœ¨ ìš”ì²­í•˜ì‹  ëŒ€ë¡œ ìˆ˜ì •ëœ í•¨ìˆ˜ì…ë‹ˆë‹¤ âœ¨âœ¨âœ¨
    // ==========================================================
    function updateAnnualSummary() {
      const annualSummaryDiv = document.getElementById('annualSummary');
      let yearly = {};
      Object.entries(allData).forEach(([date, arr]) => {
        const [y] = date.split('-');
        if (!yearly[y]) yearly[y] = { ì†Œë¹„: 0, íˆ¬ì: 0, ìˆ˜ì…: 0 };
        arr.forEach(item => {
          yearly[y][item.main] += Number(item.amount);
        });
      });

      let html = `<h3>ğŸ“ˆ ì—°ê°„ ìš”ì•½</h3>`;
      
      const years = Object.keys(yearly);
      if (years.length === 0) {
        annualSummaryDiv.innerHTML = html + "<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }
      
      // 'ëˆ„ì ìì‚°'ì„ ë¹¼ê³  'ì´ìˆ˜ì…', 'ì´ì§€ì¶œ', 'ìì‚°ì¦ê°'ìœ¼ë¡œ í…Œì´ë¸” í—¤ë” ë³€ê²½
      html += `<table class="summary-table">
                 <tr>
                   <th>ì—°ë„</th>
                   <th>ì´ìˆ˜ì…</th>
                   <th>ì´ì§€ì¶œ</th>
                   <th>ìì‚°ì¦ê°</th>
                 </tr>`;

      years.sort().forEach(y => {
        const ìˆ˜ì… = yearly[y].ìˆ˜ì… || 0;
        const ì†Œë¹„ = yearly[y].ì†Œë¹„ || 0;
        const íˆ¬ì = yearly[y].íˆ¬ì || 0;
        const ì´ì§€ì¶œ = ì†Œë¹„ + íˆ¬ì; // ì´ì§€ì¶œ ê³„ì‚°
        const ìì‚°ì¦ê° = ìˆ˜ì… - ì´ì§€ì¶œ; // ìì‚°ì¦ê° ê³„ì‚°

        // ìƒˆë¡œìš´ êµ¬ì¡°ë¡œ í…Œì´ë¸” í–‰ ì¶”ê°€
        html += `<tr>
                   <td>${y}</td>
                   <td>${ìˆ˜ì….toLocaleString()}</td>
                   <td>${ì´ì§€ì¶œ.toLocaleString()}</td>
                   <td>${ìì‚°ì¦ê° >= 0 ? "+" : ""}${ìì‚°ì¦ê°.toLocaleString()}</td>
                 </tr>`;
      });

      html += `</table>`;
      annualSummaryDiv.innerHTML = html;
      // ì°¨íŠ¸ ë° ì—°ë§ ë©”ì‹œì§€ ê´€ë ¨ ì½”ë“œëŠ” ëª¨ë‘ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
    }

    // ì´ˆê¸°í™”
    renderCalendar(currentYear, currentMonth);
  </script>

</body>
</html>
