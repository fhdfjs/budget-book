<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>마스터의 가계부</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    select, input { margin: 5px; padding: 5px; }
    .summary-table { margin-top:30px; width:auto; }
    #charts { display:flex; flex-wrap:wrap; gap:30px; margin-top:30px; }
    .chart-area { width:340px; }
  </style>
</head>
<body>
  <h1>📒 마스터의 가계부</h1>
  <form id="entryForm">
    <input type="date" id="date" required />
    <select id="mainCategory">
      <option value="소비">소비</option>
      <option value="투자">투자</option>
      <option value="수입">수입</option>
    </select>
    <select id="subCategory"></select>
    <input type="number" id="amount" placeholder="금액" required />
    <input type="text" id="note" placeholder="메모" />
    <button type="submit">추가</button>
  </form>

  <h2>📋 목록</h2>
  <table>
    <thead>
      <tr><th>날짜</th><th>항목</th><th>하위항목</th><th>금액</th><th>메모</th></tr>
    </thead>
    <tbody id="dataTable"></tbody>
  </table>

  <div id="monthlySummary"></div>
  <div id="charts"></div>
  <div id="annualSummary"></div>

  <script>
    // 하위카테고리
    const subCategories = {
      '소비': ['식비', '교통비', '고정지출', '공과금', '거주비용', '문화비', '자기개발비', '기타(소비)'],
      '투자': ['적금', '보험', '주식', '가상화폐', '수집품', '기타(투자)'],
      '수입': ['월급', '이자수입', '배당수입', '기타수입']
    };
    const mainSelect = document.getElementById('mainCategory');
    const subSelect = document.getElementById('subCategory');
    const tableBody = document.getElementById('dataTable');
    const form = document.getElementById('entryForm');
    let allData = [];
    let initialAsset = 0; // 최초 자산(연말 계산용)

    function updateSubCategories() {
      const selected = mainSelect.value;
      subSelect.innerHTML = '';
      subCategories[selected].forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        subSelect.appendChild(opt);
      });
    }
    mainSelect.addEventListener('change', updateSubCategories);
    window.onload = function() {
      updateSubCategories();
      updateMonthlySummary();
      updateCharts();
      updateAnnualSummary();
    };

    // 입력 이벤트
    form.addEventListener('submit', e => {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const main = mainSelect.value;
      const sub = subSelect.value;
      const amount = Number(document.getElementById('amount').value);
      const note = document.getElementById('note').value;
      allData.push({ date, main, sub, amount, note });
      addRow(date, main, sub, amount, note);
      updateMonthlySummary();
      updateCharts();
      updateAnnualSummary();
      form.reset();
      updateSubCategories();
    });

    // 표에 행 추가
    function addRow(date, main, sub, amount, note) {
      const row = document.createElement('tr');
      [date, main, sub, amount, note].forEach(val => {
        const cell = document.createElement('td');
        cell.textContent = val;
        row.appendChild(cell);
      });
      tableBody.appendChild(row);
    }

    // --- 월별 집계 (소비/투자/수입/잉여금) ---
    function updateMonthlySummary() {
      let summary = {};
      allData.forEach(item => {
        if (!item.date) return;
        const month = item.date.slice(0, 7);
        if (!summary[month]) summary[month] = { 소비:0, 투자:0, 수입:0 };
        summary[month][item.main] += Number(item.amount);
      });

      // 표 출력
      let html = `<table class="summary-table"><tr>
        <th>월</th>
        <th>소비</th>
        <th>투자</th>
        <th>수입</th>
        <th>잉여금</th>
      </tr>`;
      Object.keys(summary).sort().forEach(month=>{
        let 소비 = summary[month]['소비']||0;
        let 투자 = summary[month]['투자']||0;
        let 수입 = summary[month]['수입']||0;
        let 잉여금 = 수입 - (소비 + 투자);
        html += `<tr>
          <td>${month}</td>
          <td>${소비}</td>
          <td>${투자}</td>
          <td>${수입}</td>
          <td>${잉여금}</td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById('monthlySummary').innerHTML = html;
    }

    // --- 월별 그래프 ---
    function updateCharts() {
      const chartDiv = document.getElementById('charts');
      chartDiv.innerHTML = '';
      const summary = {};
      allData.forEach(item=>{
        if (!item.date) return;
        const month = item.date.slice(0,7);
        if (!summary[month]) summary[month] = {소비:0,투자:0,수입:0};
        summary[month][item.main] += Number(item.amount);
      });
      Object.keys(summary).sort().forEach(month=>{
        const data = [
          summary[month]['소비'],
          summary[month]['투자'],
          summary[month]['수입'],
        ];
        const colors = ['#ffb300','#82b1ff','#43a047'];
        const canvas = document.createElement('canvas');
        canvas.id = 'chart-'+month;
        canvas.width = 300; canvas.height = 300;
        chartDiv.appendChild(Object.assign(document.createElement('div'),{className:'chart-area',innerHTML:`<h4>${month} 소비/투자/수입 비율</h4>`}));
        chartDiv.lastChild.appendChild(canvas);
        new Chart(canvas.getContext('2d'),{
          type:'pie',
          data:{
            labels:['소비','투자','수입'],
            datasets:[{
              data:data,
              backgroundColor: colors
            }]
          },
          options:{
            plugins:{ legend:{position:'bottom'} }
          }
        });
      });
    }

    // --- 연말 자산증감/그래프 ---
    function updateAnnualSummary() {
      // 연도별 누적자산 = 전년+수입-소비-투자
      let yearly = {};
      allData.forEach(item=>{
        if (!item.date) return;
        const [y] = item.date.split('-');
        if (!yearly[y]) yearly[y]={소비:0,투자:0,수입:0};
        yearly[y][item.main] += Number(item.amount);
      });

      let years = Object.keys(yearly).sort();
      let assetArr = [];
      let yearSum = {};
      let prev = initialAsset;
      let html = "";
      years.forEach(y=>{
        let 소비 = yearly[y].소비||0, 투자=yearly[y].투자||0, 수입=yearly[y].수입||0;
        let sum = 수입 - (소비 + 투자);
        yearSum[y] = sum;
        prev += sum;
        assetArr.push(prev);
      });
      if (years.length === 0) {
        document.getElementById('annualSummary').innerHTML = "";
        return;
      }

      html += `<h3>📈 연말 자산변동</h3>`;
      html += `<table class="summary-table"><tr>
        <th>연도</th><th>자산증감(₩)</th><th>누적자산(₩)</th></tr>`;
      prev = initialAsset;
      years.forEach((y,i)=>{
        let sum = yearSum[y];
        prev += sum;
        html += `<tr>
          <td>${y}</td>
          <td>${sum>=0?"+":""}${sum}</td>
          <td>${prev}</td>
        </tr>`;
      });
      html += `</table>`;

      // 그래프
      html += `<canvas id="assetChart" width="400" height="260"></canvas>`;
      document.getElementById('annualSummary').innerHTML = html;

      // 차트
      const ctx = document.getElementById('assetChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [{
            label: '누적자산(₩)',
            data: assetArr,
            fill: false,
            borderColor: '#42a5f5',
            tension: 0.1
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          }
        }
      });

      // 메시지
      if (years.length > 1) {
        let last = assetArr[assetArr.length-1], prevY = assetArr[assetArr.length-2];
        let pct = prevY===0 ? 0 : ((last-prevY)/Math.abs(prevY)*100).toFixed(1);
        html += `<p><b>연말 메시지:</b> 올해 자산은 작년 대비 <b>${pct}% ${last-prevY>=0?'증가':'감소'}</b>했습니다.</p>`;
        document.getElementById('annualSummary').innerHTML = html;
      }
    }
  </script>
</body>
</html>
