<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë§ˆìŠ¤í„°ì˜ ê°€ê³„ë¶€</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    select, input { margin: 5px; padding: 5px; }
    .summary-table { margin-top:30px; width:auto; }
    #charts { display:flex; flex-wrap:wrap; gap:30px; margin-top:30px; }
    .chart-area { width:340px; }
  </style>
</head>
<body>
  <h1>ğŸ“’ ë§ˆìŠ¤í„°ì˜ ê°€ê³„ë¶€</h1>
  <form id="entryForm">
    <input type="date" id="date" required />
    <select id="mainCategory">
      <option value="ì†Œë¹„">ì†Œë¹„</option>
      <option value="íˆ¬ì">íˆ¬ì</option>
      <option value="ìˆ˜ì…">ìˆ˜ì…</option>
    </select>
    <select id="subCategory"></select>
    <input type="number" id="amount" placeholder="ê¸ˆì•¡" required />
    <input type="text" id="note" placeholder="ë©”ëª¨" />
    <button type="submit">ì¶”ê°€</button>
  </form>

  <h2>ğŸ“‹ ëª©ë¡</h2>
  <table>
    <thead>
      <tr><th>ë‚ ì§œ</th><th>í•­ëª©</th><th>í•˜ìœ„í•­ëª©</th><th>ê¸ˆì•¡</th><th>ë©”ëª¨</th></tr>
    </thead>
    <tbody id="dataTable"></tbody>
  </table>

  <div id="monthlySummary"></div>
  <div id="charts"></div>
  <div id="annualSummary"></div>

  <script>
    // í•˜ìœ„ì¹´í…Œê³ ë¦¬
    const subCategories = {
      'ì†Œë¹„': ['ì‹ë¹„', 'êµí†µë¹„', 'ê³ ì •ì§€ì¶œ', 'ê³µê³¼ê¸ˆ', 'ê±°ì£¼ë¹„ìš©', 'ë¬¸í™”ë¹„', 'ìê¸°ê°œë°œë¹„', 'ê¸°íƒ€(ì†Œë¹„)'],
      'íˆ¬ì': ['ì ê¸ˆ', 'ë³´í—˜', 'ì£¼ì‹', 'ê°€ìƒí™”í', 'ìˆ˜ì§‘í’ˆ', 'ê¸°íƒ€(íˆ¬ì)'],
      'ìˆ˜ì…': ['ì›”ê¸‰', 'ì´ììˆ˜ì…', 'ë°°ë‹¹ìˆ˜ì…', 'ê¸°íƒ€ìˆ˜ì…']
    };
    const mainSelect = document.getElementById('mainCategory');
    const subSelect = document.getElementById('subCategory');
    const tableBody = document.getElementById('dataTable');
    const form = document.getElementById('entryForm');
    let allData = [];
    let initialAsset = 0; // ìµœì´ˆ ìì‚°(ì—°ë§ ê³„ì‚°ìš©)

    function updateSubCategories() {
      const selected = mainSelect.value;
      subSelect.innerHTML = '';
      subCategories[selected].forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        subSelect.appendChild(opt);
      });
    }
    mainSelect.addEventListener('change', updateSubCategories);
    window.onload = function() {
      updateSubCategories();
      updateMonthlySummary();
      updateCharts();
      updateAnnualSummary();
    };

    // ì…ë ¥ ì´ë²¤íŠ¸
    form.addEventListener('submit', e => {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const main = mainSelect.value;
      const sub = subSelect.value;
      const amount = Number(document.getElementById('amount').value);
      const note = document.getElementById('note').value;
      allData.push({ date, main, sub, amount, note });
      addRow(date, main, sub, amount, note);
      updateMonthlySummary();
      updateCharts();
      updateAnnualSummary();
      form.reset();
      updateSubCategories();
    });

    // í‘œì— í–‰ ì¶”ê°€
    function addRow(date, main, sub, amount, note) {
      const row = document.createElement('tr');
      [date, main, sub, amount, note].forEach(val => {
        const cell = document.createElement('td');
        cell.textContent = val;
        row.appendChild(cell);
      });
      tableBody.appendChild(row);
    }

    // --- ì›”ë³„ ì§‘ê³„ (ì†Œë¹„/íˆ¬ì/ìˆ˜ì…/ì‰ì—¬ê¸ˆ) ---
    function updateMonthlySummary() {
      let summary = {};
      allData.forEach(item => {
        if (!item.date) return;
        const month = item.date.slice(0, 7);
        if (!summary[month]) summary[month] = { ì†Œë¹„:0, íˆ¬ì:0, ìˆ˜ì…:0 };
        summary[month][item.main] += Number(item.amount);
      });

      // í‘œ ì¶œë ¥
      let html = `<table class="summary-table"><tr>
        <th>ì›”</th>
        <th>ì†Œë¹„</th>
        <th>íˆ¬ì</th>
        <th>ìˆ˜ì…</th>
        <th>ì‰ì—¬ê¸ˆ</th>
      </tr>`;
      Object.keys(summary).sort().forEach(month=>{
        let ì†Œë¹„ = summary[month]['ì†Œë¹„']||0;
        let íˆ¬ì = summary[month]['íˆ¬ì']||0;
        let ìˆ˜ì… = summary[month]['ìˆ˜ì…']||0;
        let ì‰ì—¬ê¸ˆ = ìˆ˜ì… - (ì†Œë¹„ + íˆ¬ì);
        html += `<tr>
          <td>${month}</td>
          <td>${ì†Œë¹„}</td>
          <td>${íˆ¬ì}</td>
          <td>${ìˆ˜ì…}</td>
          <td>${ì‰ì—¬ê¸ˆ}</td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById('monthlySummary').innerHTML = html;
    }

    // --- ì›”ë³„ ê·¸ë˜í”„ ---
    function updateCharts() {
      const chartDiv = document.getElementById('charts');
      chartDiv.innerHTML = '';
      const summary = {};
      allData.forEach(item=>{
        if (!item.date) return;
        const month = item.date.slice(0,7);
        if (!summary[month]) summary[month] = {ì†Œë¹„:0,íˆ¬ì:0,ìˆ˜ì…:0};
        summary[month][item.main] += Number(item.amount);
      });
      Object.keys(summary).sort().forEach(month=>{
        const data = [
          summary[month]['ì†Œë¹„'],
          summary[month]['íˆ¬ì'],
          summary[month]['ìˆ˜ì…'],
        ];
        const colors = ['#ffb300','#82b1ff','#43a047'];
        const canvas = document.createElement('canvas');
        canvas.id = 'chart-'+month;
        canvas.width = 300; canvas.height = 300;
        chartDiv.appendChild(Object.assign(document.createElement('div'),{className:'chart-area',innerHTML:`<h4>${month} ì†Œë¹„/íˆ¬ì/ìˆ˜ì… ë¹„ìœ¨</h4>`}));
        chartDiv.lastChild.appendChild(canvas);
        new Chart(canvas.getContext('2d'),{
          type:'pie',
          data:{
            labels:['ì†Œë¹„','íˆ¬ì','ìˆ˜ì…'],
            datasets:[{
              data:data,
              backgroundColor: colors
            }]
          },
          options:{
            plugins:{ legend:{position:'bottom'} }
          }
        });
      });
    }

    // --- ì—°ë§ ìì‚°ì¦ê°/ê·¸ë˜í”„ ---
    function updateAnnualSummary() {
      // ì—°ë„ë³„ ëˆ„ì ìì‚° = ì „ë…„+ìˆ˜ì…-ì†Œë¹„-íˆ¬ì
      let yearly = {};
      allData.forEach(item=>{
        if (!item.date) return;
        const [y] = item.date.split('-');
        if (!yearly[y]) yearly[y]={ì†Œë¹„:0,íˆ¬ì:0,ìˆ˜ì…:0};
        yearly[y][item.main] += Number(item.amount);
      });

      let years = Object.keys(yearly).sort();
      let assetArr = [];
      let yearSum = {};
      let prev = initialAsset;
      let html = "";
      years.forEach(y=>{
        let ì†Œë¹„ = yearly[y].ì†Œë¹„||0, íˆ¬ì=yearly[y].íˆ¬ì||0, ìˆ˜ì…=yearly[y].ìˆ˜ì…||0;
        let sum = ìˆ˜ì… - (ì†Œë¹„ + íˆ¬ì);
        yearSum[y] = sum;
        prev += sum;
        assetArr.push(prev);
      });
      if (years.length === 0) {
        document.getElementById('annualSummary').innerHTML = "";
        return;
      }

      html += `<h3>ğŸ“ˆ ì—°ë§ ìì‚°ë³€ë™</h3>`;
      html += `<table class="summary-table"><tr>
        <th>ì—°ë„</th><th>ìì‚°ì¦ê°(â‚©)</th><th>ëˆ„ì ìì‚°(â‚©)</th></tr>`;
      prev = initialAsset;
      years.forEach((y,i)=>{
        let sum = yearSum[y];
        prev += sum;
        html += `<tr>
          <td>${y}</td>
          <td>${sum>=0?"+":""}${sum}</td>
          <td>${prev}</td>
        </tr>`;
      });
      html += `</table>`;

      // ê·¸ë˜í”„
      html += `<canvas id="assetChart" width="400" height="260"></canvas>`;
      document.getElementById('annualSummary').innerHTML = html;

      // ì°¨íŠ¸
      const ctx = document.getElementById('assetChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [{
            label: 'ëˆ„ì ìì‚°(â‚©)',
            data: assetArr,
            fill: false,
            borderColor: '#42a5f5',
            tension: 0.1
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          }
        }
      });

      // ë©”ì‹œì§€
      if (years.length > 1) {
        let last = assetArr[assetArr.length-1], prevY = assetArr[assetArr.length-2];
        let pct = prevY===0 ? 0 : ((last-prevY)/Math.abs(prevY)*100).toFixed(1);
        html += `<p><b>ì—°ë§ ë©”ì‹œì§€:</b> ì˜¬í•´ ìì‚°ì€ ì‘ë…„ ëŒ€ë¹„ <b>${pct}% ${last-prevY>=0?'ì¦ê°€':'ê°ì†Œ'}</b>í–ˆìŠµë‹ˆë‹¤.</p>`;
        document.getElementById('annualSummary').innerHTML = html;
      }
    }
  </script>
</body>
</html>
