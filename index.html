<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë§ˆìŠ¤í„°ì˜ ê°€ê³„ë¶€</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    select, input { margin: 5px; padding: 5px; }
    .summary-table { margin-top:30px; width:auto; }
    .asset-control { width:80px; }
    #charts { display:flex; flex-wrap:wrap; gap:30px; margin-top:30px; }
    .chart-area { width:340px; }
  </style>
</head>
<body>
  <h1>ğŸ“’ ë§ˆìŠ¤í„°ì˜ ê°€ê³„ë¶€</h1>
  <form id="entryForm">
    <input type="date" id="date" required />
    <select id="mainCategory">
      <option value="ì†Œë¹„">ì†Œë¹„</option>
      <option value="íˆ¬ì">íˆ¬ì</option>
      <option value="ìˆ˜ì…">ìˆ˜ì…</option>
    </select>
    <select id="subCategory"></select>
    <input type="number" id="amount" placeholder="ê¸ˆì•¡" required />
    <input type="text" id="note" placeholder="ë©”ëª¨" />
    <button type="submit">ì¶”ê°€</button>
  </form>

  <h2>ğŸ“‹ ëª©ë¡</h2>
  <table>
    <thead>
      <tr><th>ë‚ ì§œ</th><th>í•­ëª©</th><th>í•˜ìœ„í•­ëª©</th><th>ê¸ˆì•¡</th><th>ë©”ëª¨</th></tr>
    </thead>
    <tbody id="dataTable"></tbody>
  </table>

  <div id="monthlySummary"></div>
  <div id="charts"></div>
  <div id="annualSummary"></div>

  <script>
    // ì„œë¸Œì¹´í…Œê³ ë¦¬
    const subCategories = {
      'ì†Œë¹„': ['ì‹ë¹„', 'êµí†µë¹„', 'ê³ ì •ì§€ì¶œ', 'ê³µê³¼ê¸ˆ', 'ê±°ì£¼ë¹„ìš©', 'ë¬¸í™”ë¹„', 'ìê¸°ê°œë°œë¹„', 'ê¸°íƒ€(ì†Œë¹„)'],
      'íˆ¬ì': ['ì ê¸ˆ', 'ë³´í—˜', 'ì£¼ì‹', 'ê°€ìƒí™”í', 'ìˆ˜ì§‘í’ˆ', 'ê¸°íƒ€(íˆ¬ì)'],
      'ìˆ˜ì…': ['ì›”ê¸‰', 'ì´ììˆ˜ì…', 'ë°°ë‹¹ìˆ˜ì…', 'ê¸°íƒ€ìˆ˜ì…']
    };
    const mainSelect = document.getElementById('mainCategory');
    const subSelect = document.getElementById('subCategory');
    const tableBody = document.getElementById('dataTable');
    const form = document.getElementById('entryForm');
    let allData = [];
    let assetCorrection = {}; // { 'YYYY-MM': +-ê°’ }
    let initialAsset = 0; // ìµœì´ˆ ìì‚° ì…ë ¥ (ì—°ë§ ê³„ì‚°ìš©)

    function updateSubCategories() {
      const selected = mainSelect.value;
      subSelect.innerHTML = '';
      subCategories[selected].forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        subSelect.appendChild(opt);
      });
    }
    mainSelect.addEventListener('change', updateSubCategories);
    window.onload = updateSubCategories;

    // ì…ë ¥ ì´ë²¤íŠ¸
    form.addEventListener('submit', e => {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const main = mainSelect.value;
      const sub = subSelect.value;
      const amount = Number(document.getElementById('amount').value);
      const note = document.getElementById('note').value;
      allData.push({ date, main, sub, amount, note });
      addRow(date, main, sub, amount, note);
      updateMonthlySummary();
      updateCharts();
      updateAnnualSummary();
      form.reset();
      updateSubCategories();
    });

    // í‘œì— í–‰ ì¶”ê°€
    function addRow(date, main, sub, amount, note) {
      const row = document.createElement('tr');
      [date, main, sub, amount, note].forEach(val => {
        const cell = document.createElement('td');
        cell.textContent = val;
        row.appendChild(cell);
      });
      tableBody.appendChild(row);
    }

    // --- ì›”ë³„ ì§‘ê³„ & ìˆ˜ë™ì…ë ¥ ---
    function updateMonthlySummary() {
      // ì›”ë³„ í•©ê³„ ê³„ì‚°
      let summary = {};
      allData.forEach(item => {
        if (!item.date) return;
        const month = item.date.slice(0, 7);
        if (!summary[month]) summary[month] = { ì†Œë¹„:0, íˆ¬ì:0, ìˆ˜ì…:0, ìì‚°ì¡°ì •:assetCorrection[month]||0 };
        summary[month][item.main] += item.main==='ìˆ˜ì…' ? Number(item.amount) : Number(item.amount);
      });

      // í‘œ ì¶œë ¥
      let html = `<table class="summary-table"><tr>
      <th>ì›”</th><th>ì†Œë¹„í•©ê³„</th><th>íˆ¬ìí•©ê³„</th><th>ìˆ˜ì…í•©ê³„</th><th>ìì‚°ì¡°ì •(+/-)</th><th>ì…ë ¥</th></tr>`;
      Object.keys(summary).sort().forEach(month=>{
        html += `<tr>
        <td>${month}</td>
        <td>${summary[month]['ì†Œë¹„']||0}</td>
        <td>${summary[month]['íˆ¬ì']||0}</td>
        <td>${summary[month]['ìˆ˜ì…']||0}</td>
        <td id="asset-corr-${month}">${summary[month].ìì‚°ì¡°ì •||0}</td>
        <td>
          <input class="asset-control" type="number" id="input-${month}" placeholder="+/-" value="${assetCorrection[month]||''}"/>
          <button onclick="setAssetCorrection('${month}')">ë°˜ì˜</button>
        </td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById('monthlySummary').innerHTML = html;
    }

    // ìì‚°ì¡°ì • ë°˜ì˜
    window.setAssetCorrection = function(month) {
      const v = Number(document.getElementById('input-'+month).value)||0;
      assetCorrection[month]=v;
      updateMonthlySummary();
      updateAnnualSummary();
      updateCharts();
    };

    // --- ì›”ë³„ ê·¸ë˜í”„ ---
    let pieChart;
    function updateCharts() {
      const chartDiv = document.getElementById('charts');
      chartDiv.innerHTML = '';
      const summary = {};
      allData.forEach(item=>{
        if (!item.date) return;
        const month = item.date.slice(0,7);
        if (!summary[month]) summary[month] = {ì†Œë¹„:0,íˆ¬ì:0,ìˆ˜ì…:0};
        summary[month][item.main] += Number(item.amount);
      });
      Object.keys(summary).sort().forEach(month=>{
        // ë¹„ìœ¨ ë°ì´í„°
        const total = summary[month]['ì†Œë¹„']+summary[month]['íˆ¬ì']+summary[month]['ìˆ˜ì…'];
        const data = [
          summary[month]['ì†Œë¹„'],
          summary[month]['íˆ¬ì'],
          summary[month]['ìˆ˜ì…'],
        ];
        const colors = ['#ffb300','#82b1ff','#43a047'];
        const canvas = document.createElement('canvas');
        canvas.id = 'chart-'+month;
        canvas.width = 300; canvas.height = 300;
        chartDiv.appendChild(Object.assign(document.createElement('div'),{className:'chart-area',innerHTML:`<h4>${month} ì†Œë¹„/íˆ¬ì/ìˆ˜ì… ë¹„ìœ¨</h4>`}));
        chartDiv.lastChild.appendChild(canvas);
        new Chart(canvas.getContext('2d'),{
          type:'pie',
          data:{
            labels:['ì†Œë¹„','íˆ¬ì','ìˆ˜ì…'],
            datasets:[{
              data:data,
              backgroundColor: colors
            }]
          },
          options:{
            plugins:{ legend:{position:'bottom'} }
          }
        });
      });
    }

    // --- ì—°ë§ ìì‚°ì¦ê°/ê·¸ë˜í”„ ---
    function updateAnnualSummary() {
      // ì—°ë„ë³„ ëˆ„ì ìì‚° = ì „ë…„+ìˆ˜ì…-ì†Œë¹„-íˆ¬ì+ìì‚°ì¡°ì •
      let yearly = {};
      let prev = initialAsset;
      let months = Object.keys(assetCorrection).concat(allData.map(i=>i.date.slice(0,7)));
      months = Array.from(new Set(months)).sort();
      let yearAsset = {};
      months.forEach(month=>{
        const [y,m] = month.split('-');
        if (!yearly[y]) yearly[y] = {ì†Œë¹„:0,íˆ¬ì:0,ìˆ˜ì…:0,ìì‚°ì¡°ì •:0};
      });
      allData.forEach(item=>{
        if (!item.date) return;
        const [y,m] = item.date.split('-');
        if (!yearly[y]) yearly[y]={ì†Œë¹„:0,íˆ¬ì:0,ìˆ˜ì…:0,ìì‚°ì¡°ì •:0};
        yearly[y][item.main] += Number(item.amount);
      });
      Object.keys(assetCorrection).forEach(month=>{
        const [y,m] = month.split('-');
        yearly[y].ìì‚°ì¡°ì • += assetCorrection[month];
      });
      // ëˆ„ì  ìì‚°
      let asset = initialAsset;
      let assetArr = [];
      Object.keys(yearly).sort().forEach((year,i)=>{
        asset += yearly[year].ìˆ˜ì… - yearly[year].ì†Œë¹„ - yearly[year].íˆ¬ì + yearly[year].ìì‚°ì¡°ì •;
        assetArr.push({year,asset});
      });
      // ì‘ë…„ëŒ€ë¹„ ì¦ê°€ìœ¨
      let html = `<h3>ì—°ë§ ìì‚° ì¦ê°</h3>
      <input type="number" placeholder="ì‘ë…„ë§ ìì‚°" id="initAsset" style="width:120px;" value="${initialAsset||''}" onchange="setInitAsset(this.value)"/>
      <table class="summary-table"><tr>
        <th>ì—°ë„</th><th>ì—°ë§ ìì‚°</th><th>ì‘ë…„ ëŒ€ë¹„ ì¦ê°(%)</th></tr>`;
      assetArr.forEach((item,i)=>{
        let diff = i>0 ? (((item.asset-assetArr[i-1].asset)/assetArr[i-1].asset)*100).toFixed(1)+'%' : '-';
        html+= `<tr><td>${item.year}</td><td>${item.asset}</td><td>${diff}</td></tr>`;
      });
      html+=`</table>
      <canvas id="assetChart" width="400" height="260"></canvas>`;
      document.getElementById('annualSummary').innerHTML = html;
      // ê·¸ë˜í”„
      if (assetArr.length>0){
        new Chart(document.getElementById('assetChart').getContext('2d'),{
          type:'line',
          data:{
            labels: assetArr.map(x=>x.year),
            datasets:[{
              label:'ì—°ë§ ìì‚°',
              data: assetArr.map(x=>x.asset),
              fill:false, borderColor:'#42a5f5', tension:0.2
            }]
          },
          options:{
            plugins:{legend:{display:false}},
            scales:{y:{beginAtZero:true}}
          }
        });
      }
    }
    window.setInitAsset=function(v){
      initialAsset=Number(v)||0;
      updateAnnualSummary();
    }

    // --- ì´ˆê¸° ë¡œë”©ì‹œ í‘œì™€ ì§‘ê³„ ê°±ì‹  ---
    updateMonthlySummary();
    updateCharts();
    updateAnnualSummary();
  </script>
</body>
</html>
