<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÎÇòÏùò Í∞ÄÍ≥ÑÎ∂Ä</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      transition: background 0.5s; 
      margin: 0;
      padding: 0;
      background-color: #f4f7f6;
    }
    .container { 
      max-width: 1200px; 
      margin: auto; 
      padding: 20px; 
    }
    .header { 
      text-align: center; 
      margin-bottom: 20px; 
      background: rgba(255, 255, 255, 0.7);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .season-info { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 15px; 
      margin-bottom: 20px; 
    }
    .season-info img { 
      width: 50px; 
      height: 50px; 
    }
    #seasonFoods span { 
      background-color: rgba(0,0,0,0.05); 
      padding: 5px 10px; 
      border-radius: 15px; 
      margin: 0 4px; 
      font-size: 0.9em; 
      display: inline-block;
      margin-top: 5px;
    }
    .calendar-controls { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 10px; 
    }
    .calendar-controls button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .calendar-controls button:hover {
      background-color: #0056b3;
    }
    #calendar { 
      display: grid; 
      grid-template-columns: repeat(7, 1fr); 
      gap: 5px; 
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .calendar-header, .calendar-day { 
      padding: 10px; 
      text-align: center; 
      border-radius: 5px; 
    }
    .calendar-header { 
      background-color: #f0f0f0; 
      font-weight: bold; 
    }
    .calendar-day { 
      background-color: #fff; 
      cursor: pointer; 
      border: 1px solid #eee;
      min-height: 60px;
    }
    .calendar-day:hover { 
      background-color: #e9ecef; 
    }
    .calendar-day.empty { 
      background-color: transparent; 
      cursor: default; 
      border: none;
    }
    .calendar-day.today { 
      border: 2px solid #42a5f5; 
      font-weight: bold; 
    }
    .calendar-day.has-data { 
      font-weight: bold;
      color: #d32f2f; 
    }
    #entryBox { 
      display: none; 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: white; 
      padding: 25px; 
      border-radius: 10px; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
      z-index: 100; 
      width: 90%; 
      max-width: 500px; 
    }
    #entryForm { 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
    }
    #entryForm input, #entryForm select, #entryForm button {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #entryForm button {
      background-color: #28a745;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .summary-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .summary-table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 10px; 
    }
    .summary-table th, .summary-table td { 
      border: 1px solid #ddd; 
      padding: 8px; 
      text-align: right; 
    }
    .summary-table th { 
      background-color: #f2f2f2; 
      text-align: center; 
    }
    .charts-container { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 20px; 
      justify-content: center; 
      margin-top: 20px; 
    }
    .chart-area { 
      text-align: center; 
    }
    hr {
      border: none;
      border-top: 1px solid #eee;
      margin: 30px 0;
    }
  </style>
</head>
<body>

  <div class="container">
    <header class="header">
      <div class="season-info">
        <img id="seasonImg" src="" alt="season-icon">
        <div>
          <h2 id="seasonText"></h2>
          <div id="seasonFoods"></div>
        </div>
      </div>
      <div class="calendar-controls">
        <button id="prevMonth">‚óÄ Ïù¥Ï†Ñ Îã¨</button>
        <h1 id="monthTitle"></h1>
        <button id="nextMonth">Îã§Ïùå Îã¨ ‚ñ∂</button>
      </div>
    </header>
    
    <main>
      <div id="calendar"></div>
      
      <div class="summary-section" id="monthlySummary"></div>

      <div class="summary-section" id="annualSummary"></div>
      
      <div class="summary-section">
        <h3>ÏõîÎ≥Ñ ÏÉÅÏÑ∏ Ï∞®Ìä∏</h3>
        <div class="charts-container" id="charts"></div>
      </div>

    </main>
  </div>

  <div id="entryBox">
    <h3 id="selectedDate"></h3>
    <form id="entryForm">
      <select id="mainCategory">
        <option value="ÏÜåÎπÑ">ÏÜåÎπÑ</option>
        <option value="Ìà¨Ïûê">Ìà¨Ïûê</option>
        <option value="ÏàòÏûÖ">ÏàòÏûÖ</option>
      </select>
      <select id="subCategory"></select>
      <input type="number" id="amount" placeholder="Í∏àÏï°" required>
      <input type="text" id="note" placeholder="Î©îÎ™®">
      <button type="submit">Ï†ÄÏû•</button>
    </form>
    <table class="summary-table" style="margin-top: 20px;">
      <thead>
        <tr><th>ÎåÄÎ∂ÑÎ•ò</th><th>ÏÜåÎ∂ÑÎ•ò</th><th>Í∏àÏï°</th><th>Î©îÎ™®</th><th>ÏÇ≠Ï†ú</th></tr>
      </thead>
      <tbody id="dataTable"></tbody>
    </table>
    <button id="closeEntry" style="margin-top: 15px;">Îã´Í∏∞</button>
  </div>

  <script>
    // 1. Í≥ÑÏ†à/Ï†úÏ≤† ÏãùÌíà/Ïù¥ÎØ∏ÏßÄ/ÌååÏä§ÌÖîÌÜ§
    const SEASON_MAP = [
      { name: "Î¥Ñ", months: [3,4,5], bg: "#ffeef7", img: "https://openmoji.org/data/color/svg/1F353.svg", foods: ["Îî∏Í∏∞üçì", "ÎëêÎ¶Ö", "Ïë•", "Îã¨Îûò", "ÎØ∏ÎÇòÎ¶¨"] },
      { name: "Ïó¨Î¶Ñ", months: [6,7,8], bg: "#e3faff", img: "https://openmoji.org/data/color/svg/1F349.svg", foods: ["ÏàòÎ∞ïüçâ", "Ï∞∏Ïô∏", "Ïò•ÏàòÏàòüåΩ", "Ïò§Ïù¥ü•í"] },
      { name: "Í∞ÄÏùÑ", months: [9,10,11], bg: "#fff7e3", img: "https://openmoji.org/data/color/svg/1F34E.svg", foods: ["Î∞§üå∞", "Í∞ê", "ÏÇ¨Í≥ºüçé", "Í≥†Íµ¨Îßà", "Î≤ÑÏÑØ"] },
      { name: "Í≤®Ïö∏", months: [12,1,2], bg: "#eaf3ff", img: "https://openmoji.org/data/color/svg/1F34A.svg", foods: ["Í∑§üçä", "Î∞∞Ï∂î", "Î¨¥", "ÎåÄÌåå", "Î∞©Ïñ¥üêü"] }
    ];
    function getSeason(month) { return SEASON_MAP.find(season => season.months.includes(month)); }
    function updateSeasonUI(month) {
      const season = getSeason(month);
      document.body.style.background = season.bg;
      document.getElementById('seasonImg').src = season.img;
      document.getElementById('seasonText').textContent = `${season.name}Ïùò Ï†úÏ≤†`;
      document.getElementById('seasonFoods').innerHTML = season.foods.map(f => `<span>${f}</span>`).join('');
    }

    // 2. Í∞ÄÍ≥ÑÎ∂Ä/Îã¨Î†• Í∏∞Î≥∏
    const subCategories = {
      'ÏÜåÎπÑ': ['ÏãùÎπÑ', 'ÍµêÌÜµÎπÑ', 'Í≥†Ï†ïÏßÄÏ∂ú', 'Í≥µÍ≥ºÍ∏à', 'Í±∞Ï£ºÎπÑÏö©', 'Î¨∏ÌôîÎπÑ', 'ÏûêÍ∏∞Í∞úÎ∞úÎπÑ', 'Í∏∞ÌÉÄ(ÏÜåÎπÑ)'],
      'Ìà¨Ïûê': ['Ï†ÅÍ∏à', 'Î≥¥Ìóò', 'Ï£ºÏãù', 'Í∞ÄÏÉÅÌôîÌèê', 'ÏàòÏßëÌíà', 'Í∏∞ÌÉÄ(Ìà¨Ïûê)'],
      'ÏàòÏûÖ': ['ÏõîÍ∏â', 'Ïù¥ÏûêÏàòÏûÖ', 'Î∞∞ÎãπÏàòÏûÖ', 'Í∏∞ÌÉÄÏàòÏûÖ']
    };
    const today = new Date();
    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth();
    let allData = {};
    let initialAsset = 0;

    function renderCalendar(year, month) {
      updateSeasonUI(month+1);
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';
      document.getElementById('monthTitle').textContent = `${year}ÎÖÑ ${month+1}Ïõî`;
      const weekDays = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
      weekDays.forEach(d => {
        let hd = document.createElement('div');
        hd.className = 'calendar-header'; hd.textContent = d; calendar.appendChild(hd);
      });
      let firstDay = new Date(year, month, 1).getDay();
      let lastDate = new Date(year, month+1, 0).getDate();
      for(let i=0; i<firstDay; i++) {
        let emp = document.createElement('div'); emp.className = 'calendar-day empty'; calendar.appendChild(emp);
      }
      for(let date=1; date<=lastDate; date++) {
        let key = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
        let hasData = allData[key] && allData[key].length>0;
        let cell = document.createElement('div');
        cell.className = 'calendar-day' + (today.getFullYear()===year&&today.getMonth()===month&&today.getDate()===date?' today':'') + (hasData?' has-data':'');
        let dateSpan = document.createElement('span'); dateSpan.textContent = date; cell.appendChild(dateSpan);
        if(hasData) { let dot = document.createElement('div'); dot.textContent = '‚óè'; dot.style.fontSize = '0.7em'; cell.appendChild(dot); }
        cell.onclick = () => showEntryBox(key, year, month, date);
        calendar.appendChild(cell);
      }
      updateMonthlySummary();
      updateCharts();
      updateAnnualSummary();
    }

    function showEntryBox(key, year, month, date) {
      document.getElementById('entryBox').style.display = 'block';
      document.getElementById('selectedDate').textContent = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')} ÎÇ¥Ïó≠`;
      renderEntryTable(key);
      const form = document.getElementById('entryForm');
      form.onsubmit = null; 
      form.onsubmit = function(e){
        e.preventDefault();
        const main = document.getElementById('mainCategory').value;
        const sub = document.getElementById('subCategory').value;
        const amount = Number(document.getElementById('amount').value);
        const note = document.getElementById('note').value;
        if(!allData[key]) allData[key] = [];
        allData[key].push({main,sub,amount,note});
        renderEntryTable(key);
        renderCalendar(currentYear, currentMonth);
        this.reset();
        updateSubCategories();
      };
      document.getElementById('closeEntry').onclick = () => { document.getElementById('entryBox').style.display = 'none'; };
      document.getElementById('mainCategory').onchange = updateSubCategories;
      updateSubCategories();
    }
    function updateSubCategories() {
      const main = document.getElementById('mainCategory').value;
      const subSel = document.getElementById('subCategory');
      subSel.innerHTML = '';
      subCategories[main].forEach(sub => {
        let opt = document.createElement('option'); opt.value = sub; opt.textContent = sub; subSel.appendChild(opt);
      });
    }
    function renderEntryTable(key) {
      const table = document.getElementById('dataTable');
      table.innerHTML = '';
      (allData[key]||[]).forEach((item, idx)=>{
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.main}</td><td>${item.sub}</td><td>${item.amount.toLocaleString()}</td><td>${item.note}</td>
        <td><button onclick="deleteEntry('${key}',${idx})">ÏÇ≠Ï†ú</button></td>`;
        table.appendChild(tr);
      });
    }
    window.deleteEntry = function(key, idx){
      if(confirm('Ï†ïÎßêÎ°ú Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        if(allData[key]) {
          allData[key].splice(idx,1);
          renderEntryTable(key);
          renderCalendar(currentYear, currentMonth);
        }
      }
    }
    document.getElementById('prevMonth').onclick = () => {
      currentMonth--; if(currentMonth<0) { currentMonth=11; currentYear--; }
      renderCalendar(currentYear, currentMonth); document.getElementById('entryBox').style.display = 'none';
    };
    document.getElementById('nextMonth').onclick = () => {
      currentMonth++; if(currentMonth>11) { currentMonth=0; currentYear++; }
      renderCalendar(currentYear, currentMonth); document.getElementById('entryBox').style.display = 'none';
    };

    function updateMonthlySummary() {
      const monthlySummaryDiv = document.getElementById('monthlySummary');
      let summary = {};
      Object.entries(allData).forEach(([date, arr])=>{
        const month = date.slice(0,7);
        if (!summary[month]) summary[month] = { ÏÜåÎπÑ:0, Ìà¨Ïûê:0, ÏàòÏûÖ:0 };
        arr.forEach(item=>{ summary[month][item.main] += Number(item.amount); });
      });
      let html = `<h3>ÏõîÎ≥Ñ ÏöîÏïΩ</h3>`;
      if (Object.keys(summary).length === 0) {
        monthlySummaryDiv.innerHTML = html + "<p>Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>"; return;
      }
      html += `<table class="summary-table"><tr><th>Ïõî</th><th>ÏÜåÎπÑ</th><th>Ìà¨Ïûê</th><th>ÏàòÏûÖ</th><th>ÏûâÏó¨Í∏à</th></tr>`;
      Object.keys(summary).sort().forEach(month=>{
        let ÏÜåÎπÑ = summary[month]['ÏÜåÎπÑ']||0, Ìà¨Ïûê = summary[month]['Ìà¨Ïûê']||0, ÏàòÏûÖ = summary[month]['ÏàòÏûÖ']||0;
        let ÏûâÏó¨Í∏à = ÏàòÏûÖ - (ÏÜåÎπÑ + Ìà¨Ïûê);
        html += `<tr><td>${month}</td><td>${ÏÜåÎπÑ.toLocaleString()}</td><td>${Ìà¨Ïûê.toLocaleString()}</td><td>${ÏàòÏûÖ.toLocaleString()}</td><td>${ÏûâÏó¨Í∏à.toLocaleString()}</td></tr>`;
      });
      html += `</table>`;
      monthlySummaryDiv.innerHTML = html;
    }
    function updateCharts() {
      const chartDiv = document.getElementById('charts');
      chartDiv.innerHTML = '';
      const summary = {};
      Object.entries(allData).forEach(([date, arr])=>{
        const month = date.slice(0,7);
        if (!summary[month]) summary[month] = { ÏÜåÎπÑ:0, Ìà¨Ïûê:0, ÏàòÏûÖ:0 };
        arr.forEach(item=>{ summary[month][item.main] += Number(item.amount); });
      });
      Object.keys(summary).sort().forEach(month=>{
        const data = [ summary[month]['ÏÜåÎπÑ'], summary[month]['Ìà¨Ïûê'], summary[month]['ÏàòÏûÖ'] ];
        if (data.every(item => item === 0)) return;
        const colors = ['#ffb300','#82b1ff','#43a047'];
        const canvas = document.createElement('canvas'); canvas.id = 'chart-'+month;
        const chartArea = document.createElement('div'); chartArea.className = 'chart-area';
        chartArea.innerHTML = `<h4>${month} ÏÜåÎπÑ/Ìà¨Ïûê/ÏàòÏûÖ ÎπÑÏú®</h4>`; chartArea.appendChild(canvas);
        chartDiv.appendChild(chartArea);
        new Chart(canvas.getContext('2d'),{ type:'pie', data:{ labels:['ÏÜåÎπÑ','Ìà¨Ïûê','ÏàòÏûÖ'], datasets:[{ data:data, backgroundColor: colors }] }, options:{ responsive: true, maintainAspectRatio: false, plugins:{ legend:{position:'bottom'} } } });
      });
    }

    // ==========================================================
    // ‚ú®‚ú®‚ú® ÏöîÏ≤≠ÌïòÏã† ÎåÄÎ°ú ÏàòÏ†ïÎêú Ìï®ÏàòÏûÖÎãàÎã§ ‚ú®‚ú®‚ú®
    // ==========================================================
    function updateAnnualSummary() {
      const annualSummaryDiv = document.getElementById('annualSummary');
      let yearly = {};
      Object.entries(allData).forEach(([date, arr]) => {
        const [y] = date.split('-');
        if (!yearly[y]) yearly[y] = { ÏÜåÎπÑ: 0, Ìà¨Ïûê: 0, ÏàòÏûÖ: 0 };
        arr.forEach(item => {
          yearly[y][item.main] += Number(item.amount);
        });
      });

      let html = `<h3>üìà Ïó∞Í∞Ñ ÏöîÏïΩ</h3>`;
      
      const years = Object.keys(yearly);
      if (years.length === 0) {
        annualSummaryDiv.innerHTML = html + "<p>Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>";
        return;
      }
      
      // 'ÎàÑÏ†ÅÏûêÏÇ∞'ÏùÑ ÎπºÍ≥† 'Ï¥ùÏàòÏûÖ', 'Ï¥ùÏßÄÏ∂ú', 'ÏûêÏÇ∞Ï¶ùÍ∞ê'ÏúºÎ°ú ÌÖåÏù¥Î∏î Ìó§Îçî Î≥ÄÍ≤Ω
      html += `<table class="summary-table">
                 <tr>
                   <th>Ïó∞ÎèÑ</th>
                   <th>Ï¥ùÏàòÏûÖ</th>
                   <th>Ï¥ùÏßÄÏ∂ú</th>
                   <th>ÏûêÏÇ∞Ï¶ùÍ∞ê</th>
                 </tr>`;

      years.sort().forEach(y => {
        const ÏàòÏûÖ = yearly[y].ÏàòÏûÖ || 0;
        const ÏÜåÎπÑ = yearly[y].ÏÜåÎπÑ || 0;
        const Ìà¨Ïûê = yearly[y].Ìà¨Ïûê || 0;
        const Ï¥ùÏßÄÏ∂ú = ÏÜåÎπÑ + Ìà¨Ïûê; // Ï¥ùÏßÄÏ∂ú Í≥ÑÏÇ∞
        const ÏûêÏÇ∞Ï¶ùÍ∞ê = ÏàòÏûÖ - Ï¥ùÏßÄÏ∂ú; // ÏûêÏÇ∞Ï¶ùÍ∞ê Í≥ÑÏÇ∞

        // ÏÉàÎ°úÏö¥ Íµ¨Ï°∞Î°ú ÌÖåÏù¥Î∏î Ìñâ Ï∂îÍ∞Ä
        html += `<tr>
                   <td>${y}</td>
                   <td>${ÏàòÏûÖ.toLocaleString()}</td>
                   <td>${Ï¥ùÏßÄÏ∂ú.toLocaleString()}</td>
                   <td>${ÏûêÏÇ∞Ï¶ùÍ∞ê >= 0 ? "+" : ""}${ÏûêÏÇ∞Ï¶ùÍ∞ê.toLocaleString()}</td>
                 </tr>`;
      });

      html += `</table>`;
      annualSummaryDiv.innerHTML = html;
      // Ï∞®Ìä∏ Î∞è Ïó∞Îßê Î©îÏãúÏßÄ Í¥ÄÎ†® ÏΩîÎìúÎäî Î™®Îëê Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§.
    }

    // Ï¥àÍ∏∞Ìôî
    renderCalendar(currentYear, currentMonth);
  </script>

</body>
</html>
